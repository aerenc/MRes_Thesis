%% RM THESIS IN EOR - 2021

%% SEVERAL APPROACHES TO UNOBSERVED PRODUCT CHARACTERISTICS WITH SIMULATED DATA UNDER LOGIT & RC-LOGIT SPECIFICATION
% Ali Eren Camur
% Tilburg University - CentER

%%

clc;
clear;

global  beta alpha Total I J M T x m t extra_noise constant share IV price indexxx W Ktheta IDmkt A z tol_inner Kbeta v v_J one Indicator error error_J iterativedelta Kmc zero marginalcost g gg zeta heterogeneity base_heterogeneity

rng('default');                                                            % Setting seed for the whole thesis

%% 1 - SIMULATION:

% In the first part of this code, I will generate the required data:

%% SIMULATION SETTING - LOGIT

% Generating the data for logit case first, we will extend the required data for the RC logit:

alpha         = 2;                    % True alpha
beta          = [3,3,0.5,0.5]';       % True betas (B0 ; B1 ; B2 ; B3)
gamma         = [5,1,0.5,0.5]';       % True gamma
theta_logit   = [beta;-alpha;gamma];  % True theta (but w/o heterogeneity (i.e. sigma) parameters)

I             = 50;                   % Total number of consumers in each market (will be used in estimation part)
J             = 6;                    % Initial total good + outside share in each market
M             = 20;                   % Total markets
T             = 10;                   % Total time period
Total         = J*M*T;                % Total goods present "a priori" i.e. "real" data + first good in first market at first time period,
                                      % INCLUDING outside goods for each M*T market-time combo

one           = 1;
%% CONSTRUCTING INDEXES:

% We construct some indexes for the simulated data: straight out indexes
% correspond to the unmanipulated data and m_ indexes correspond to the
% manipulated data, also constructing the dropping index which is defined
% as in indexes function:

[base_index, base_indexx, base_index2 ,base_index3, index, indexx, index2, index3, indexxx, IDmkt] = indexes(J,M,T,Total); 

%% SIMULATING THE BASE DATA:

% Herein, I simulate the baseline data:

[base_x_jmt, base_w_jmt, base_xi_jmt, base_omega_jmt, base_mc_jmt] = simulateDataUnmanipulated(J,M,T,Total,gamma);
x;
m;
t;
extra_noise;

%% SOLVING FOR SHARES & PRICES FOR UNMANIPULATED DATA BY LOGIT SPECIFICATION:

base_inits                 = zeros(Total-M*T,1);                           % Getting initial values for getting eq. prices

base_solveforprices_logit  = @(ppp) (ppp -(1./(alpha.*(1 - base_shares(ppp,base_x_jmt,base_xi_jmt,base_index,base_index2,base_index3)))) - base_mc_jmt);
opts                 = optimset('Display','iter','TolCon',1E-8,'TolFun',1E-8,'TolX',1E-10,'MaxFunEvals',1000000000);

tic
base_p_jmt_logit     = fsolve(base_solveforprices_logit,base_inits,opts);  % This gives us equilibrium prices for logit-based simulation
toc

base_s_jmt_logit     = base_shares(base_p_jmt_logit,base_x_jmt,base_xi_jmt,base_index,base_index2,base_index3);
                                                                           % This gives us inner market shares                                                                         
cumsum_s_jmt         = cumsum(base_s_jmt_logit);
cumsum_s_jmt_1       = cumsum_s_jmt(J-1,:);
marketwisesum_s_jmt  = diff(cumsum_s_jmt(base_indexx,:)); 
marketwisesum_s_jmt  = [cumsum_s_jmt_1;marketwisesum_s_jmt]; 
base_s0_mt_logit     = 1 - marketwisesum_s_jmt;                            % Getting outside shares for each M*T combo
clear cumsum_s_jmt cumsum_s_jmt_1 marketwisesum_s_jmt marketwisesum_s_jmt

%% SIMULATION SETTING - RC-LOGIT:

% We will introduce heterogeneity on constant term and price:

sigmaa   = [0.8,0.5]';                                                     % Heterogeneity term for RC logit (for constant + price)
theta    = [alpha;beta;sigmaa;gamma];                                      % True theta
base_heterogeneity = randn(2,I);

%% SOLVING FOR SHARES & PRICES FOR UNMANIPULATED DATA BY RC-LOGIT SPECIFICATION:

base_solveforprices = @(pp) (pp -(1./(alpha.*(1 - base_shares_RC(pp,base_x_jmt,base_xi_jmt,sigmaa,base_index,base_index2,base_index3)))) - base_mc_jmt);

tic
base_p_jmt             = fsolve(base_solveforprices,base_inits,opts);      % This gives us equilibrium prices for RC-based simulation
toc

base_s_jmt             = base_shares_RC(base_p_jmt,base_x_jmt,base_xi_jmt,sigmaa,base_index,base_index2,base_index3);     
                                                                           % This gives us inner market shares
cumsum_s_jmt           = cumsum(base_s_jmt);
cumsum_s_jmt_1         = cumsum_s_jmt(J-1,:);
marketwisesum_s_jmt    = diff(cumsum_s_jmt(base_indexx,:)); 
marketwisesum_s_jmt    = [cumsum_s_jmt_1;marketwisesum_s_jmt]; 
base_s0_mt             = 1 - marketwisesum_s_jmt;                          % Getting outside shares for each M*T combo
clear cumsum_s_jmt cumsum_s_jmt_1 marketwisesum_s_jmt 

%% MANIPULATION: GETTING THE "REAL" DATA:

% Now, we will drop the first good from the first market in the first time
% period and resimulate the data for logit and RC-logit cases:

[x_jmt, w_jmt, xi_jmt, omega_jmt, mc_jmt]  = simulateDataManipulated(base_x_jmt,base_w_jmt,base_xi_jmt,base_omega_jmt,base_mc_jmt);

%% SOLVING FOR SHARES & PRICES FOR "REAL" DATA USING LOGIT SPECIFICATION:

inits               = ones(Total-M*T-1,1);                                 % Getting initial values for getting eq. prices

solveforprices_logit= @(pr) (pr -(1./(alpha.*(1 - shares(pr,x_jmt,xi_jmt,index,index2,index3)))) - mc_jmt);

tic
p_jmt_logit         = fsolve(solveforprices_logit,inits,opts);             % This gives us equilibrium prices for logit-based simulation
toc

s_jmt_logit         = shares(p_jmt_logit,x_jmt,xi_jmt,index,index2,index3);% This gives us inner market shares

cumsum_s_jmt         = cumsum(s_jmt_logit);
cumsum_s_jmt_1       = cumsum_s_jmt(J-1,:);
marketwisesum_s_jmt  = diff(cumsum_s_jmt(indexx,:)); 
marketwisesum_s_jmt  = [cumsum_s_jmt_1;marketwisesum_s_jmt]; 
s0_mt_logit          = 1 - marketwisesum_s_jmt;                            % Getting outside shares for each M*T combo
clear cumsum_s_jmt cumsum_s_jmt_1 marketwisesum_s_jmt

%% SOLVING FOR SHARES & PRICES FOR "REAL" DATA USING RC-LOGIT SPECIFICATION:

heterogeneity = randn(2,I);

solveforprices       = @(pr) (pr -(1./(alpha.*(1 - shares_RC(pr,x_jmt,xi_jmt,sigmaa,index,index2,index3)))) - mc_jmt);

tic
p_jmt                = fsolve(solveforprices,inits,opts);                  % This gives us equilibrium prices for logit-based simulation
toc

%For x & w normrnd specification, J=6,M=20,T=10 and I=50
% p_jmt = [7.67443191915855;6.12950388155064;8.02446478001840;5.89285476747259;7.68911320173416;5.66069120037535;7.81067111804373;7.27890566226072;8.74314585290272;5.05862418854567;8.29840095040236;7.53903631970598;8.10206002605544;7.80888431837698;6.39941584157297;6.78115367788026;8.79607316815312;8.19105149097831;8.61054613082556;8.19854192633817;7.50972691969239;5.40671588675675;6.48194188501898;5.24219939049747;6.38614293177602;6.33754366160461;8.99200291433414;6.84067460250420;8.25825739019037;7.46230221073094;7.28423929822776;9.22388912081064;6.34813245679924;6.60172045122237;6.56927974037759;5.17769005924901;8.05896936328786;6.31021660857133;7.10495604592522;5.65760208252052;7.79746197239877;5.55999799843909;7.66284095461281;7.47408285785279;6.24989364981634;5.73086297705867;7.56149963542695;7.48462381732990;5.63916219507667;7.85605503966615;6.92579446778786;6.87258345576368;6.64008763387170;7.45215866393165;6.29583462636585;8.09592882856306;6.75763955976264;6.54482509578801;6.25811084099934;7.73175729056688;8.09846180503942;5.89479427471687;8.94622559127877;7.90778582831211;7.49616023321068;8.91136018225880;7.72813293190884;8.13820643400715;8.05434143273969;6.37054852350938;6.21505602204611;7.54204498980953;6.30807913214907;8.63783445428403;5.48205781936421;7.28997246027905;10.3496156911829;7.64338363523018;5.82092822445083;7.06658949457311;6.54284853302278;6.33578193156845;7.54809158673637;7.84698928287154;5.02232696192373;5.57081908479468;6.50165562035989;6.93685809274404;5.56553057266989;5.57619759736870;4.08976347075488;7.52089359623493;8.00377332366384;8.67151381744333;5.25405554033176;5.65070629101708;7.75807625285745;7.19759793263736;6.95870197045287;5.72585423765378;5.43107328701799;10.0818040524083;6.06979397307491;7.93313116820271;3.91333363916097;4.99801649509434;5.75716241013647;7.11391015137765;9.00612770732128;10.0081973375233;5.82934365873044;5.61960453804486;7.22243355029082;7.84310603995747;5.67247051487321;8.24641213804713;7.27002383955775;8.63828163960840;7.05612468851807;4.92347609548819;8.14011953670915;5.99963437121527;6.11073510575214;7.58217172306193;7.83992351126589;8.19452849997371;6.98734381714893;4.50828068404420;7.50722740363362;6.78758535289361;8.35482046866490;7.87906922495035;7.52995179718977;7.11023184445277;7.79918615875749;7.07086165499621;6.77756127524373;6.75357050351979;9.02909891075017;5.54246894100886;7.95698721024864;9.14794364183550;5.77953285544303;8.43249594617637;7.60183183209094;6.75231278189029;6.84205459471749;6.56454053801464;6.27422812703490;8.99196682811417;9.36276477383350;7.29814873973091;5.94697343340311;5.76773963669573;6.52405420144303;5.79709912300721;4.04412110820607;5.63483984028816;8.30468591372742;5.12918095661614;8.69723839348111;6.80676902038057;5.98062294959415;7.94642218150371;7.22163347814302;7.06808009127967;5.56309329112407;3.88864971134973;6.13782686650294;7.33160341393555;7.36294966510655;4.99056459551615;8.64961821082587;8.19147067095723;6.18012913025580;5.84117377902905;6.44854695091825;6.88115414807088;7.05285206350688;7.56288816050407;8.16796711067906;4.34289182245972;6.35296552502970;7.05112463744703;6.00734014355787;6.20926892292204;7.87906110370212;7.51424728958272;7.16188301483091;7.30071298230082;5.53104289227843;6.39423550688361;7.16980723249384;6.04317000572055;7.78062743923461;7.08287905826362;7.45538246930037;6.58069508980304;7.18699233080907;7.38964325034129;5.71228724775489;8.62091434780626;4.99207298764539;8.63005727460254;7.94981786351016;6.08025953168185;9.25113589622479;8.08617855175219;7.32059096176614;6.20481254748328;6.47017056774601;8.08853604924641;7.48569733595167;6.53462790716883;10.3799597698843;9.46833579513613;8.54468128210772;8.44688682717765;7.64774995352367;5.43903743957419;6.54059595049313;9.19248876169337;6.96115980868389;8.76790232191323;8.56475885912082;6.08749248813811;6.81299291238454;6.97713741829004;8.51514522098166;6.05002471954325;6.15229006846066;7.37131706049258;7.76379044803965;6.69662334443485;4.56229187230866;8.68325002119190;7.16104197882751;5.99137642989007;7.40481654889676;6.80233438244988;5.92790275732066;7.48566537883927;4.65246051572809;5.93877220463521;6.45703514502825;7.12482810617321;7.99367886223288;8.31994455051614;8.37137583717306;8.51551482692381;4.49206711358952;8.48374646805675;7.89516105968750;8.08780325465252;6.28407562110464;6.73433443915140;6.53295632128087;7.12209487260601;7.92427832679933;6.77713836027246;4.55660159933717;8.34214061186135;6.99948597339456;8.44170662424432;7.45607200959755;5.53770702659634;6.93553061894153;7.43132774650261;6.85562362226862;7.69280423804333;7.28662894347203;5.31880224678874;6.63979663389078;8.10201802691771;6.82178398730579;6.12548742414094;5.89300288779834;5.09409514302014;7.39472685164024;5.69833830565597;7.76514515283682;7.46894236458841;8.24883026432418;4.81421520127855;7.01137609696388;6.33099731984374;9.05110024581488;7.08544171821311;9.48084987168136;6.35904967523034;6.00474777632706;8.49960409968962;7.89558936768931;5.16074736598448;3.36934522304694;7.48666191879586;6.80704774086885;8.54388612975483;7.83855778516396;7.42539898399078;8.13678262060636;6.07204663143837;5.99957265543042;6.75332978682483;5.57897778504071;8.80402294251221;6.53918058190590;4.64225285963292;5.95737648025895;6.29131094264319;6.01756378042163;7.53537912360426;8.02155903634448;7.75767078554295;7.00372637474546;7.26139766708563;6.16840953456631;7.59020191839660;6.53555099680177;6.12432324908399;6.64749674408158;5.92246378628303;5.61725578879854;5.97009990019232;8.67735190545602;7.61425662501012;6.98968903751440;9.40874886987958;6.93778484541198;8.37578944840700;7.06928397453923;5.86121734417791;6.94440321441992;5.96471213122029;6.40594228594842;6.39816112776383;8.09681914734655;5.68294233658437;6.87765041435738;5.45445158472171;7.03803519796039;8.79914452664939;7.09849213647514;6.86864036212971;6.58564161031757;7.75312849675120;8.44223553743581;6.12717076675756;7.51207224860070;8.50153841859780;9.22667711384869;6.89973816795289;7.91902014649776;6.77286639075835;5.16423803099220;6.93421358838184;5.67660057540906;6.43985455599860;7.33145979997456;7.84465016128761;7.30813085494376;4.95272066182265;6.85415355574982;6.23335115142366;6.68925695297497;9.37102888745102;6.16717723540035;7.85029655356603;7.76627023437983;4.88836860777706;7.54495688220240;6.18827915430474;7.35995005484965;6.75245552390201;8.36449202000655;8.55073012070886;6.81608928440440;8.88856548685960;5.76137017057357;7.20768490784378;6.42729244037760;7.51112011251812;9.05638396335623;5.59125671358878;7.19385268896318;8.18313265922352;4.94554136804003;9.02942807555532;7.32693006840965;5.24573572138344;6.58430249940438;6.69991881764537;7.63239162595697;6.58122601878931;7.28952121637710;6.07729986574598;8.47760497679179;7.86098577917750;5.68965903790080;4.39130016668125;6.88847598322210;5.11674300484256;6.95021177414845;9.97528527508916;6.64299278897554;5.79142984416941;7.14922348095168;8.62531740979202;8.71489596967782;7.93704150351439;9.52346203595529;9.54057356174177;5.60637139733246;6.64483693453334;7.47235575279386;7.78306235172423;7.34872517341158;6.01631855727510;5.42501698926781;8.03281158686121;6.34920443508245;6.20378592968636;5.02441894339846;5.76437380433947;7.27889413971953;7.68351393850204;8.64366861034859;8.68444177995401;6.60621773773491;8.22209920247342;9.80606755280782;7.71954939657182;8.10374941288176;6.51548315212401;8.50151810720183;5.49650979320106;6.81635784509309;6.77389326551176;7.00407822837991;6.78576867759389;4.86417256169389;7.08503165938632;6.45581016449276;8.27566860191768;8.35519919619347;8.27339313592574;8.54134331495296;5.81271449430335;8.60242238261429;6.55757687278802;6.86801053185164;6.55679118647575;6.58606083690982;5.75068213435076;9.21153757856873;6.59563689907060;6.21995015545831;6.59459579115631;7.10915348378859;8.03929291008659;6.88944058737770;6.66501922226678;6.59836731879586;9.20353316886087;7.26249984554332;5.67880041493605;9.62806640555403;5.87337950583586;7.88573768580115;8.34520742498695;7.53202459104814;8.65944605400413;6.08123117547017;8.45661063008438;4.45048323002418;4.70010245653364;8.38775169150249;7.20284810733732;6.17475687826012;8.01675492324752;4.51907714109953;6.47871818290299;4.92597050763736;7.14685355786639;7.88660302155752;5.92876065031909;6.08735137721942;7.72381764501537;6.99563835640777;6.59084903752411;7.21299294685876;8.31427827101830;7.15771131786513;7.30070008239722;7.97576713574661;6.01452315074191;6.69948016171046;6.28749663038633;7.18487902078962;5.80753814083806;7.09117065796173;6.60104426332895;6.88165504002235;7.90205854755554;6.74589601955728;9.71030756156424;8.48631975652299;7.47388405507398;5.18419566840387;5.96295548262643;7.89611283580947;5.42958503903909;8.75666775676219;7.88325667014939;7.08334462124699;6.76734803343014;6.79814384056628;7.35331690713890;5.93888135131140;6.96756618092815;7.64778933110711;8.76665220471603;5.06592036594782;8.69508888757878;5.06309223431716;6.10799789820939;7.46219331827272;7.82439848363796;5.84351589032722;6.40865128703540;6.55747194384222;4.83547182168914;8.91166596519070;6.63282726314361;6.63445856174647;9.49154309272837;8.25277889379573;6.58924675179683;7.51255716695835;7.07737138464572;5.48780667995268;6.91887597038431;7.69224923232288;5.79973874060621;7.12140338498345;8.30519258835713;7.04739488317563;6.36715678330845;7.16846292889555;7.93374541999037;7.69295683430432;7.94950248863719;6.82339184443794;7.75307204692525;6.00111827059954;9.15654283082976;7.43924142544966;5.41089323879723;8.73006936578367;5.90451555300456;5.21167458493396;6.84088045180846;7.76706916518214;6.78018072279191;5.96538640146799;8.63968192169765;6.70364397787957;7.36859313874519;6.89196493731010;6.79941390604564;6.56777717139429;7.80878916203463;8.49520936464570;5.67582823092154;6.86592599014964;6.94565419908665;7.73259324557287;6.84918376054048;9.19064818568871;5.92495331672896;8.04035828795804;6.38897356397016;6.53955959506775;7.98437167765054;6.31598791726717;5.59114852617234;8.68584091534026;7.11876884731808;6.01119041691596;8.68726066730232;6.27282513407122;6.27875948774288;7.26065763275547;7.48444472539821;6.44760709342585;8.04900062172374;6.71472231137794;7.52770052593653;5.06567635640864;7.72446637956885;9.65119799903432;6.26821908291708;8.95611053205558;7.60231622372697;5.48253063012766;6.97325156897915;6.62049392743669;9.57065448557883;6.70803926257361;6.82134505017610;6.74540758084658;7.04511812015348;7.80854771032611;6.84439512791145;6.50774224037509;7.69872146536736;6.18458634016116;8.67253587143923;7.02979670773427;7.77626612957330;8.16698552157443;6.74312119285782;6.92123837152908;7.20587534302800;6.54229551299652;8.44717979863094;7.86777310105341;5.24476658929446;7.69138798866760;6.25495641762001;9.58015671791944;5.24762557275179;8.82882650590507;7.30236915907177;2.96445507610607;7.63840618223585;8.22611935483030;8.49495175371651;6.48947581337265;7.28545024575095;8.30476681848545;7.06878671423554;6.61381828135812;7.05178555113011;7.83149517346738;6.27882963242763;7.70291422143161;7.26208963849877;7.47222602611795;7.17578362433613;5.30854353241879;5.07703008398693;5.85867785896099;6.16933895595494;4.18848218308760;7.50870580546546;8.58431665569580;7.00736677017407;8.94340504417042;7.11876497781755;7.27798752910237;5.55429828398846;10.3387897991029;6.29919543602792;9.33700258240443;6.75601262349762;6.17780123354828;7.00153382331185;5.41685914459929;5.37867428299807;6.32467319629960;6.09656445159742;8.14515307394763;7.16712047256322;6.93686461440576;6.00995776856339;9.21415141480945;5.97483626660250;7.12692231969733;6.89579404236627;6.67018749953077;7.73494982816370;6.04244003793759;6.72984864931905;5.67131588060668;7.12352510056397;9.00499994946931;6.72699165747676;8.71104905837105;7.56437056251806;10.2554412590946;6.32084725335390;7.18305055183426;6.42278558520660;6.06189843580194;7.57331600281262;8.68362799576296;6.47084009521667;6.23287595811354;6.43193985253352;6.65790582939211;5.73846264062252;6.14302213786675;7.41709586743033;7.82140750855626;6.63545803659679;6.81788167243471;5.34115818190253;5.72080619936883;7.42049708024851;7.28424739243398;9.24675401434049;5.67195258101794;6.55887422455821;7.86841325236575;7.04266708851704;7.10100507376959;10.1343610011569;5.93840231720054;6.61198839149686;5.91491939355004;4.33283673419017;8.51481488352168;9.11805085319866;6.49572654919403;7.35841434138648;5.67126345561329;7.52605646535552;8.22578696336095;4.19493877476549;4.23062253738546;6.80918142491461;7.49641510341246;8.27722338945997;8.02151667569346;7.25111594871850;5.27498561250637;7.21323469321029;7.31696776908024;7.56702328000294;8.05124203908301;7.48212766707351;8.41300192981624;7.93327739414896;4.95575340347999;7.29827023663792;6.90466890267105;6.31391253034680;6.06880298867931;5.90379601891836;8.46898429813667;6.29150672766572;3.66887794814287;6.41072883981462;4.95502164733854;8.37398211068463;5.33585007450907;7.37076167143352;7.46301660971866;7.17307852097249;6.40594493191623;4.81160495596393;7.48039395063716;7.19048300582161;8.62254916195349;5.08332366681306;4.07384540952114;5.89185252474589;7.55125292992170;7.13285988088585;8.85611901947813;8.32658834292343;5.37178425917223;8.76617060721610;9.54755986007038;5.56908741589235;6.71510506404605;7.24610529415810;5.24317171048336;6.55655216626147;4.94554409863822;7.33511239689627;7.01871834256083;6.63011102960966;7.18487890538504;9.58126357080764;7.25106728195153;8.60946532018167;6.22412087640536;4.80662243469160;6.47922607435289;7.12029584570820;6.65701199676701;6.98547490496416;7.17709319076593;6.70522109595990;7.61979725920615;5.82207058082835;7.92068048031383;7.57311781452848;8.15041081418966;7.87447200821838;8.94617146091531;8.29783949821745;5.69236998963892;5.00092408601056;5.74432918956882;7.43223305716043;5.36218710450591;9.00949111701286;6.35964555101736;6.41633149785717;5.73727966431403;9.24526948589229;8.60082525410036;6.60994790097692;6.88226466086884;6.99892480244875;7.31950488530257;8.61851821781581;8.89581682049256;8.74786427590733;6.71397831008486;5.48375881901128;7.60320159972043;7.96720351368365;7.57790629748321;5.78059008056799;6.85512422558783;7.96195243515266;6.94319942286522;6.71619658267447;6.89243876487965;8.30184379160216;8.33897246595858;6.97931168152756;7.79954453816865;8.72837692360691;6.49024394382148;6.61714337117529;7.66904122555099;9.18416655882323;7.62394760389683;6.44783295618564;5.65528426427712;6.75195550013448;6.17537079044850;8.36472186546153;7.85862588799416;5.21447260177227;3.19572910133205;9.19624869019928;7.73535268127835;8.53010506515951;7.95465792149335;6.99084721495224;8.96797707219472;8.64321335849517;6.05888349030354;6.90367045368191;6.37954209382006;7.87479825822747;7.62008149727915;7.45047462181082;7.05280683629319;7.28098845772571;6.73393716795983;7.69007081579758;7.45868337622303;7.86313642474076;8.57782331321201;5.12896389657764;5.67872741122979;6.09040431579650;7.92900982971411;6.10758790225273;5.99441544842315;6.87350533288029;7.26383696674842;8.04631678485744;6.64177707059896;8.12799918348837;4.65192482569282;7.03464763215942;7.97840868608703;4.90383492239556;6.82938306224169;8.20081558313222;5.56428697640722;6.62658566975266;5.19902214863265;8.24527313809031;5.72146303437537;4.70357793272615;8.32309752265474;5.77473737183655;7.39484125446893;6.70392245404385;6.57177799869563;7.25045509166327;6.85389540781601;6.46730756859979;6.87162556910834;7.77839508601387;6.01190257239673;6.08995544356692;10.2342583898861;6.01023340475511;6.85014786456511;8.53362806820486;5.55023799102329;7.12747387111207;7.40137288706429;5.59978592323416;8.22853202918027;8.80342602823114;8.16887830909051;6.75980283889519;6.46434872936207;6.17380938671860;7.32361006957728;6.92394769958563;7.72586686484596;4.75092167538061;9.31538502100016;5.68409869418090;8.73438339757027;6.19791016958228;6.17267623612128;9.31123922886128;6.17661069299348;7.37098483885433;6.74036444801918;7.27359103670418;6.92429159312953;6.11187656932757;10.2470841792414;7.65889686283884;8.11700720348448;6.02854469619530;7.21865600946409;6.87380092630262;7.29451661516433;7.05041254847197;7.08522867734311;4.87128120300426;6.17017120065737;6.02459949034249;8.75485979136180;6.11501582788915;8.94002499719456;6.61857044159228;7.18073649365559;8.37739670599471;7.11151087004338;5.81905762465439;6.32172722458134;5.63991539149471;6.13517002685815;6.56891281308550;5.39030486942775;9.04421225179061;4.85954867081133;6.43339329313857;6.26264296565059;6.28270708940277;7.65042564117940;6.68160355402560;8.29781781470250;6.27448502150344;8.66596501458361;7.57121659760586;5.35720101477885;7.87143501484415;4.22816213872180;6.98489303697915;9.06304614992196;6.29029683472153;9.07320120027169;7.44627663245946;6.61880140552335;8.57584578674552;7.25621226707293;8.10124739461709;5.50898648130556;6.19312759478015;7.61305096676329;5.81855164320400;7.32258755957281;5.49807879698191;6.78308990075626;4.96299913759499;6.48355835763971;6.20572159767594;6.29522480745909;8.33906101188417;6.57245987826376;5.11579826450676;4.97726024938460];

%For x& w unifrnd specification (-2:2 for all x and 0:1 for all w), J=6,M=20,T=10 and I=50
% p_jmt = [6.35711877334859;7.38301319783463;6.50021996424051;6.10343278212187;6.82824686011333;5.76807912528747;7.32946010096384;6.05453592524799;5.98828091796574;7.44283290653184;6.71162580273060;5.53820479496457;5.74210038572146;5.17351403979059;7.01831208864332;5.62648499327546;6.77702945465840;8.01321322697924;7.86669622364882;7.34325382305569;4.74870652837988;7.58099546074900;7.81348782755668;6.71015758729670;9.02362099143875;6.03336678052059;9.16598845566641;5.17817699035915;6.13314470843930;4.67019418561265;7.04026957850528;6.66851187874604;6.09317846784890;4.85090397657322;3.69513935522842;5.27875486864684;4.49031654513174;7.38418556977204;7.35662113058714;4.37987829343127;4.78942315219981;7.31311083572270;7.25257525174750;7.33885779924119;7.91935311899796;5.66304651758501;6.29691950810162;4.78378580968498;7.71244529572821;7.60029312587818;5.52359493084229;6.83636793359582;5.68387392635141;6.94985617135375;7.51934237479681;7.94313162763458;6.79704063865952;6.56048272351821;5.78675285534883;5.89877475219977;7.44444750494189;5.89242268276479;4.59613921775268;5.63674918079472;8.00571335491894;6.75941571520882;5.74437312325094;7.02691747709765;6.93591534487575;7.41069173365132;6.40702152270741;8.91349734917308;7.99048471789048;4.14455297858128;5.07247965582438;6.86540080585296;6.87041978578696;6.24338913133135;5.64127641485117;6.09469631295282;5.20724993865474;8.63482295664983;6.24898668743193;8.37497076197530;6.42815172357473;7.04051587268188;5.40038766494899;5.55314134410229;7.44596780511977;7.07323504928799;5.47509796174700;7.16349395720479;5.93566879334731;7.89188340035151;4.99359687073980;7.82208650841466;4.98512743018659;6.76515773351172;4.57171896186334;6.23440189391835;5.86433003838824;7.67357983776537;6.14134648088469;6.86952461755670;5.58800916677628;5.75616505804264;6.99645107458205;6.61029544737272;7.00183197551283;7.76610151626793;5.18389054706014;5.50228902991495;7.27048984249488;6.78162204497326;6.19221261315894;5.86126894432261;6.36795124818154;6.26059741021000;8.09064110689378;6.29501188367473;7.60370152807344;7.57425533620129;8.25002895471822;8.32288407839558;6.64611745611118;5.22181585123212;6.04875560943776;5.85878235334050;4.82632394275966;6.31208355204127;8.34992811040673;5.27835424290118;6.51550910801514;6.50977537085716;8.64195466530237;6.34650941430768;6.29170090024529;5.30044629357704;5.97962558033529;7.41423128016696;6.94843856780663;6.71698443453887;6.72297879842398;5.69599765132464;7.09461917381338;5.69000971333200;7.42329846698953;6.79554283985583;8.26234403585483;5.21432063396403;6.35574621147813;6.37837302502932;7.12490213748044;7.00641084214642;5.35079358193058;6.60627129314328;8.21896197455632;8.42231124565834;6.47026117982341;7.79685043357867;6.01788011138488;5.62318964554896;6.49477320188058;4.81480382234350;5.81343465069301;5.74189400610885;8.62495138466721;6.86698536640164;8.55684212239789;6.47974293521971;6.77908833209823;6.91476759161602;5.73662341955116;6.61305801452788;6.10052692437579;5.18379287298057;7.49511562720060;6.27020216190240;6.15165397613283;5.81022117445290;7.00821078746144;5.97326361561101;6.90291352010421;7.31384352813875;6.73803715678214;5.93313967450267;6.07238915517917;7.80437538660680;4.98246203567901;7.04709571725058;7.18928790216345;7.17975893799195;6.61800954541725;6.90770239940647;5.32659440264402;6.73270033161903;7.47210870450952;6.85610424824403;5.92909123011640;5.92701750071314;6.66319792798010;6.85368056430419;8.24734242387216;6.71818495572653;5.95010976275031;8.05307063572524;7.87214701091520;7.08467175101989;8.19129016371594;6.28073916123745;6.25772082888360;7.30737883000716;5.45988343366266;6.96933678844971;5.29304353739177;7.11519653970586;9.08268355840189;6.25639475618449;5.90890120322553;8.16246756714028;6.14608856720820;5.72278525530827;6.55272815541473;7.20793284619835;5.20083623626434;6.03331374589098;6.61015663295471;6.32085148669423;5.14783240940916;4.06719417475825;4.55509561447138;6.77050128268015;6.72352054115381;7.30859010230234;5.61753784130871;3.79148286478134;6.98846004965857;6.77132220647638;6.33394538294943;6.12876575920722;6.28734238402905;8.89429118768373;6.17988215229336;7.38402692628025;4.39977671989160;5.23676874150462;5.63186951514874;6.53219649178954;7.32781373010843;8.82047448285782;4.85654031719629;4.50429942016490;5.82993037646989;5.58916712461494;5.09121537209760;7.62929824091403;5.92770293730445;6.41669969119639;6.64700031830059;5.05946791942389;6.90060216178894;6.93102290071318;5.24418336420000;6.22441360952572;6.54650369766986;7.86990067308024;6.08887936873613;5.52110508540924;7.33950510049307;6.05983366662352;8.75373281197311;6.83218228401494;7.55259988411917;5.95168624128024;5.84363584728002;6.66675594986399;5.51574997956666;5.78660540690113;7.68340334855067;5.98282462188378;6.39282806527663;8.47100567425977;6.21735992090757;6.53177322882427;7.42624063178234;6.60827880246328;6.62359683617184;6.28627261064271;6.54270771550054;8.21269436928602;8.44418342507792;7.16780566664780;6.19291615365053;6.57078038624605;6.27049572280265;6.74840692794579;4.51470730713500;5.35345729237721;6.19999887823061;5.89462651874029;7.51116051987992;4.18763091520648;5.92473226879751;7.17842411601167;7.16150308531438;6.24363071014904;6.66194524874734;4.40109536689469;6.14174504830428;7.00672308025943;5.96592195736174;6.73253717338433;7.35054575328115;7.70967405537839;6.28418774392047;6.84592030316889;7.07011841561640;6.24385003560200;7.46312762936426;6.28778528106605;8.15548628211643;6.70855697368816;6.49828595618744;5.73134725395265;5.53567756443413;5.09267887680128;8.23493037578261;5.95156213876457;6.28640145792456;6.32975947253620;5.77396385618923;5.99899232217740;8.04170109569158;6.97068708446440;7.05597979013733;7.59356176409804;7.85810395106742;6.41133201277599;5.87267796710949;6.70342060040833;6.30942665581887;7.84865083463105;5.03373873666982;7.26930130257646;7.89824919350921;5.48355790501739;8.47345011532353;6.97199768184624;6.43547644323769;6.61363309709051;6.59370622701545;7.26595674789665;5.95935362053672;6.19831769546816;9.55108515010502;8.22903616888018;7.17326639749031;7.93390756865057;6.50527049783138;5.00144599566325;5.82394465305154;8.64551207067189;7.33687646938274;8.36328822939072;7.63316492191603;6.53747905350429;6.30735258330364;6.41250612483980;7.49787392575991;6.29746953418508;5.43996503152901;7.64007277897966;6.36750285543281;5.18177705034392;4.66947840839227;6.30576943505961;6.40593379462476;6.29311369243577;6.21310878388031;6.35632332487749;5.16436527054984;6.18484799294934;3.79246264418818;6.23206482514105;6.19627134530618;7.18856692586666;6.16408580513861;7.48803348825494;7.52808882747785;6.97722924565992;6.22291563522947;7.51171576599917;7.80983992693541;7.87623265662661;5.99016178823075;5.27616777193681;5.08303764376173;6.34315580405139;7.23054198787204;6.15205760084984;4.78800420240083;7.55985488230781;6.21367246266005;7.65420044539904;7.44461093081933;5.59371411659117;7.08089708296838;7.31825580511732;6.28212796738251;4.94953211009376;6.74792912087619;5.38126332183514;5.90797856074024;8.01287185398669;5.86105584058440;7.36841897183062;5.70180612502372;5.04042106009169;5.50219362204602;5.30210914692041;7.45025231415218;5.80586181453586;7.33746816587838;3.86190999359039;6.36329626850395;6.07831472407195;7.78053307519453;6.97748764882212;8.46111439727867;6.48681194665800;6.23320854378594;7.20310584487815;8.05050678790465;5.70067442552722;3.59006174306233;6.50989029922071;6.67338474423511;7.94419009427370;6.13450670688522;6.72213388034128;7.23756160594956;5.69617195944265;5.16305469484323;5.77175607854064;4.86331017906255;6.89898590030856;5.77229851999514;5.24092360477821;6.29568580966157;6.85261703573885;6.24996710579724;6.98560881338876;6.94058568775571;7.07771980490246;6.14065112173811;7.36984297313306;5.94811257818615;8.27791530160273;5.73906912500574;4.79715030091560;5.52218977885916;6.24742701763275;5.79033116677652;4.93332567258526;8.76682954047726;6.74905269632045;5.42277437086994;7.89612206744195;4.83885912625059;7.97106074408801;6.51255177362713;5.86627105383996;7.42995462543180;6.06113913344366;6.38199025401794;7.10677324833372;6.67400538285433;5.66250715618872;4.78673619269770;5.19047074712102;7.26666403081261;7.15119954890180;6.15844295914746;7.53611662863421;6.92416044551043;7.32700762066848;7.96201833316568;5.74258337459608;6.32082691197941;6.75419100189439;8.18214445294563;6.81602722577494;6.07135332142998;6.35628499964400;5.18060633992588;6.15649581475139;6.14647674463659;6.88897474065363;5.95817411969282;8.26772142083454;6.40674490178157;5.76585097118457;6.77151795998000;5.84823103466735;6.50587502366876;8.71502415439433;6.85875956280668;6.96552128743634;6.90517572994222;5.88750305353367;7.80089309809422;5.98757195749624;6.76447093866228;5.49598576297801;8.26829679897932;7.49139399069011;5.49425927794671;8.15868474622642;6.13115349761408;6.53809516386479;6.71716563573071;6.90267775146309;8.99037798994936;5.31653097305850;5.24929476205446;8.01314486718739;5.57134725535147;6.69380683912230;8.55391355108181;4.34024325396533;6.54419986806487;5.73868350930992;7.24440405868872;5.49035358148159;6.93526063120705;5.92948708242800;8.03706972403986;6.85846373975259;4.98182042581784;5.45606150171358;6.55673438527364;5.20638600758233;7.79148274109167;8.43889086595720;7.70116653234067;5.38189495598027;6.79966423136994;8.06781360007929;7.47508783783196;7.29212711394785;7.50157932513778;7.74675412229556;6.96936110806260;6.84286482518552;5.84180285971210;6.42230191684544;6.71277044971464;5.52255566996358;5.53431749131454;7.41175761676010;6.25349329087827;6.45013288523714;5.08318435604963;4.95792560350691;7.33269736051210;5.97774941810626;7.33577451202355;8.41057295909401;6.14442318051127;7.26938354981930;9.91011431252445;6.14036035556586;7.14121754036459;6.86184348510734;8.10662799597562;6.06992793904148;6.38511068953154;6.76130583984561;7.01808993944928;5.73152245439378;4.26650247434961;5.40196527557126;5.57032191434919;7.52115368112748;6.95429309809209;6.75317463416455;7.12063458009332;5.84167755727803;7.04111670060360;6.19566535878997;6.68338389337922;6.18035752250083;8.17328869002878;4.97886739852619;8.95222095766703;6.60848720957012;4.85938272498859;5.52598603081663;6.69775982699834;8.24276235809347;5.42003569557261;7.37496032472393;5.84832425890005;7.30236388986769;5.86381472610150;5.37951998324644;9.29917496320606;6.47020477585528;7.51561830690126;7.36909786376785;6.35451714782411;7.86436174279754;6.60582014717405;7.33668212352576;4.89824858737564;4.59824974511398;7.49037063166811;6.14083593317449;5.90911176703137;7.50710379088141;4.42203873609511;5.45431966766282;5.95700369898525;6.94669383756299;6.86359390532324;4.79422569432488;6.08580933515442;5.89257398826751;7.11914746921604;6.06377836814558;5.53224616697557;7.29728969197968;7.19391715361269;7.05140067251244;7.04768962260341;5.36633845232136;5.66994306781143;5.78451996361382;6.91141768221785;6.99390652504880;7.31835605459592;7.12952244899651;7.65131049291970;5.86041855598626;6.13316142279485;9.32303950681973;8.00529270427557;5.78488100892876;4.51247531248082;6.20405821918656;6.00799808718172;4.70098048822228;8.10795219420352;7.80019063568156;6.68992221089946;6.23897881697285;6.86820405967558;7.04717245117413;6.55951768859743;5.63309732344050;6.74267075049936;8.19304392856803;4.92921809336356;7.81849673006049;5.39255478644198;6.16854562343817;7.24567657064241;7.38362644295930;5.61176944247515;6.43144170516371;6.05224859385363;5.43293226571602;7.26037427537872;5.96646855985386;6.32866292596637;8.31022831302047;7.44581244591025;6.66699281683754;6.80650610898500;6.59245516170467;5.09290652379589;7.29149961532556;6.95839132318441;6.97482484014325;7.46704648411218;6.54494402577376;6.21932346693604;5.36791310432136;7.20060263623422;7.69592843087816;6.88356614601648;7.22862939349856;6.37248036920238;5.87995661027342;6.78313618757648;7.47277941587166;7.54139320940750;5.94274186456627;6.91324450377332;6.17875705991183;6.79582731618629;6.75352271272654;6.93452563491320;5.79074438698642;5.73978005262078;6.92959553657870;6.31806590247347;7.24347755919032;7.39886533639158;6.93218038122464;6.54784139362197;7.21558591566837;7.25429076047713;6.07282881128169;6.96122459925329;6.46915273643145;6.88393146602467;5.19628409066239;7.09192963341609;6.17876323057335;8.66569348564489;5.52829696022995;6.66843797908079;7.91559892450233;5.67466772492324;7.11664167360896;7.58352524209220;6.61258686352984;6.02597179886770;7.13929188860845;5.16442232352878;7.30859269374606;6.29503851794324;6.43606567546996;5.57166268896347;6.48138662278225;5.76963601044209;5.86108156980979;4.26468513722648;7.12234128114059;8.31363902138158;5.62802261205293;8.26624710784608;6.38665733778573;6.21179917605537;7.03640324217603;6.65403097862619;7.37374692284954;5.42724587163837;6.46453367592015;6.78932747967204;7.44549376768577;6.74631815806703;5.78326218848198;5.77249695125193;7.23592992741750;5.07180574091729;8.10000261089517;5.87781402761511;7.02477730121816;8.42897369224483;6.05478959104562;5.77919785366251;7.40418009214368;6.94643048451199;6.61327111552803;6.43862639311497;5.60441903846131;7.43248099817748;5.75134484763205;7.35186165140335;5.34121179352224;7.89586335625132;6.66874365765450;3.88757953861530;6.70818295344755;8.55000634974420;6.43910354139165;6.13552326698898;6.26967806299119;8.10785151579498;7.60949192926660;6.95859379937801;6.64880907360725;7.06139524817095;6.08168757574206;7.62090558853126;6.82341475267512;6.86807175225361;7.20227560498161;5.16112052171086;5.85573283177742;5.16500889052570;6.58461157374899;3.91835424441486;6.13878297486312;8.05099835304150;6.65147515894933;8.12656359516758;6.64394446776828;6.65947016914418;4.79485200471745;9.42907623051094;7.20900351213842;7.34330969731578;6.76867613111521;6.88059142904323;5.84695173636259;4.00988537300259;5.71845574690140;6.21712290692243;5.89501126584551;7.17799298735184;6.80873838974800;6.31390329897633;5.41264920080211;7.48520681811349;6.37048861880024;7.33140382257014;7.38085667019339;6.15070433419333;6.60105983535484;6.45066688301478;6.41557299513480;5.26488987742197;6.42934169449873;7.55420607046212;6.54484171245151;7.04437121070497;7.25973501654383;9.72494423705776;6.23270279038345;6.95897129088524;6.10389354810669;5.68813401679570;6.37417582286577;7.13121635461624;5.83553995575690;6.53915565967135;5.67416472420319;6.41100973137897;5.69426913037351;5.50300650905477;5.25440232729794;7.49210870351279;5.88032407706288;6.51828081391202;6.07028555673505;4.09008905582740;6.86798721761125;7.01834903188460;7.22273163143511;4.87644512518826;6.83509500683439;6.95105483427636;6.60893124023865;5.84631183071358;7.74683913775086;5.86322711812341;6.82399919254719;7.24067418073012;4.54532417945716;6.61807993678143;8.02775001808197;5.99184708582565;6.64110631857317;4.96801106738167;6.64005527652713;7.45801848959243;5.57720749975357;5.60784863260369;5.92380872713172;6.57598645050427;7.48932413190016;6.52487291962372;6.83794330248270;6.03717872667496;6.67423331804557;7.12385411948771;5.88595993357992;6.96332657979260;6.85024510178812;7.59440802380678;8.22094979789813;4.38140118115357;7.99421209188417;6.15725209847997;4.77898768191826;5.70468625615385;5.81705034413203;6.18123137964783;5.75962375523590;5.59519834649916;5.57599061942268;4.88079178760079;7.27072708471113;6.09196860558795;7.19258576276956;7.18515805569786;6.22144621166324;5.56769458482083;4.77646766519831;7.39250631164037;6.97819777931517;7.68245138735971;5.93385576564062;5.13916578216529;5.46302236310608;6.41458052711073;6.36270428069184;8.49558317915306;6.77358893253547;5.33764897019725;8.19530235161208;7.50158974805054;5.26774327828409;7.08116218204155;6.82422057547184;6.26365897310853;4.79681699359548;5.43293873790568;6.81521375505266;5.26815589838918;6.13061258726066;7.29032417869293;9.11235936864458;6.93140743578812;6.98201964964654;5.70404800081265;4.49199346664999;5.62414910415138;7.34437339197445;6.51837536517742;6.35459339223887;7.82003636564915;8.23600272713127;6.95632130292558;6.25197918387684;7.07026116470043;7.71174458511205;6.66705789737770;7.67732588049846;7.72356821540138;6.68051575624324;4.96297397303100;4.97409235620615;5.65405926203581;7.52368493768399;5.67614552041762;8.69016448340106;7.18211713795009;6.95101723432384;6.21528551529612;7.57705444575241;7.94535876692604;7.20838340842791;6.13247586442343;5.63578460536360;5.96247048665658;7.15521441550660;7.50893023470232;7.99399068422387;8.08780784813110;5.31660869054128;7.94025019565485;6.78238866213292;5.60023719449673;6.63421770184618;6.26355200591784;6.68611751132526;6.32281455625862;6.11489492661065;6.32841953189076;8.02628825069250;7.57471534701102;7.17767719232034;6.96267439718381;7.76063998956888;6.04208538187186;6.28949625844484;6.36818089812694;7.95002817021109;7.06168755648440;6.23599580549557;6.08898757088832;6.27386889369410;4.82956643953538;7.51307130030451;6.79356038985538;5.80677450734836;4.59522269423162;7.57607006423717;6.80539324482470;7.29064567195177;6.63065983957095;6.60733671815574;7.78792577864220;6.91507306550518;5.21773878279771];


s_jmt                = shares_RC(p_jmt,x_jmt,xi_jmt,sigmaa,index,index2,index3);   
                                                                           % This gives us inner market shares
cumsum_s_jmt         = cumsum(s_jmt);
cumsum_s_jmt_1       = cumsum_s_jmt(J-1,:);
marketwisesum_s_jmt  = diff(cumsum_s_jmt(indexx,:)); 
marketwisesum_s_jmt  = [cumsum_s_jmt_1;marketwisesum_s_jmt]; 
s0_mt                = 1 - marketwisesum_s_jmt;                            % Getting outside shares for each M*T combo
clear cumsum_s_jmt cumsum_s_jmt_1 marketwisesum_s_jmt 

%% 2 - ESTIMATION:

% Until this point, I generated the whole required baseline data, did some
% simulation to arrive at equilibrium "data" prices and market shares. Now it's
% time to estimate the constructed model:

%% A) OLS ESTIMATION OF HOMOGENEOUS LOGIT MODEL FOR "REAL" DATA & OLS ESTIMATION OF FIRST STAGE IV FOR "REAL" DATA & 2SLS ESTIMATION OF HOMOGENEOUS LOGIT MODEL FOR "REAL" DATA:

[OLSestimates,xi_jmt_error,Twoslsestimatessecondstage] = Estimation_OLS_IV(Total,M,T,one,index3,s_jmt,s0_mt,x_jmt,p_jmt,w_jmt);
                                                                           % This gives both OLS + IV estimates for "real" data
%% B) "BLP" (RC-LOGIT) ESTIMATION OF THE MODEL:

%% B1) DEMAND ESTIMATION:

REALDATA  = [x_jmt w_jmt p_jmt s_jmt];                                     % THIS GIVES ALL REQUIRED DATA FOR BLP ESTIMATION

A     = REALDATA(:,1:3);
z     = REALDATA(:,4:6);
price = REALDATA(:,7);
share = REALDATA(:,8);

constant  = ones(Total-M*T-1,1);                                           % Creating constant for regression   
tol_inner = 1.e-14;                                                        % Tolerance for inner loop (NFXP)

Kbeta     = 2+size(A,2);                                                   % =5(constant&price&prod. characteristics) - # of parameters in mean utility
Ktheta    = 2;                                                             % =2(price&constant)          - # of parameters with random coefficient
v         = randn(Ktheta,I);                                               % Draws for share integrals during estimation
IV        = [constant A z A.^2 z.^2];                                      % Instruments
nIV       = size(IV,2);                                                    % # of instrumental variables
W         = (IV'*IV)\eye(nIV);                                             % Starting GMM weighting matrix
init      = rand(Kbeta+Ktheta,1);                                          % Starting values for all parameters; serves to simulate them uniformly
opt       = optimset('Display','iter','TolCon',1E-6,'TolFun',1E-10,'TolX',1E-10);
% options   = optimset('Display','iter','MaxIter',100000,'MaxFunEvals',1000000,'TolFun',1e-12,'TolX',1e-12,'GradObj','off','LargeScale','on');
% init_D   = [beta;-alpha;sigmaa];
x_L       = [-10*ones(Kbeta,1);zeros(Ktheta,1)];                           % Lower bounds is zero for standard deviations of random coefficients--
                                                                           % (for theta_2 parameters)
                                                                           
x_U       = [10*ones(Kbeta,1);ones(Ktheta,1)];                            % Upper bounds for standard deviations of random coefficients--
                                                                           % (for theta_2 parameters)

iterativedelta = zeros(Total-M*T-1,1);                                     % Creating a global variable for delta which will be updated each time 
                                                                           % in contraction mapping until a fixed point is attained

Indicator      = zeros(M*T,Total-M*T-1);                                   % Matrix whose rows consist of markets and columns consist of all products: 
                                                                           % It basically assigns value "1" for products present in a given market, 
                                                                           % and "0" otherwise. 
for k = 1:M*T
    Indicator(k,index3(k,1):index3(k,2)) = 1;
end
%% % FOR J=6;M=20;T=10;I=50:

tic
[X,fval_rep,exitflag,output,lambda,grad,hessian] = fmincon(@BLP_GMM_demand,init,[],[],[],[],x_L,x_U,[],opt);
toc

demandmoment = g;

xi_D         = error;

theta1D = X(1:Kbeta,1);                  % Estimated Mean Tastes

theta2D = X(Kbeta+1:Kbeta+Ktheta,1);     % Estimated Deviations from Mean Taste

%% B2) JOINT ESTIMATION:

Kmc     = 1+size(z,2);                      % =4 (constant & cost shifters) # of parameters in MC function
v_J     = randn(Ktheta,I);                  % Draws for share integrals during estimation
zero    = zeros(size(W,1),size(W,1));       % Getting matrix filled with 0s in dimension of W to be used in joint moment minimization
init_J  = rand(Kbeta+Ktheta+Kmc,1);                                  % Initial values for this part

x_L_J     = [-10*ones(Kbeta,1);zeros(Ktheta,1);-10*ones(Kmc,1)];   % Lower bounds  
x_U_J     = 10.*ones(Kbeta+Ktheta+Kmc,1);                           % Upper bounds 

tic
[X_J,fval_rep2,exitflag2,output2,lambda2] = fmincon(@BLP_GMM_joint,init_J,[],[],[],[],x_L_J,x_U_J,[],opt);
toc

xi_J           = error_J;

demandmoment_J = gg;

supplymoment_J = zeta;

mc_J           = marginalcost;

theta1J = X_J(1:Kbeta,1);                        % Estimated Mean Tastes

theta2J = X_J(Kbeta+1:Kbeta+Ktheta,1);           % Estimated Deviations from Mean Taste

gammaJ  = X_J(Kbeta+Ktheta+1:Kbeta+Ktheta+Kmc);  % MC estimates

theta_J = [theta1J; theta2J];


